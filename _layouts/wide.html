<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ page.title | default: site.title }}</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Merriweather&family=Raleway:wght@700&display=swap"
    rel="stylesheet"
  >
  <link rel="stylesheet" href="{{ '/assets/css/custom.css' | relative_url }}">
</head>
<body>
  <header class="site-header"> ... </header>
  
  <main class="content-wide">
    {{ content }}
  </main>

  <!-- Scripts go here... -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.5/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>

  <script>
    $(document).ready(function(){
      const csvFilePath = "{{ '/Sources_by_type/Manntall.csv' | relative_url }}";

      // Fix #1: Use "width" not "with"
      const columns = [
        { data: 'Census_type', width: '100px' },
        { data: 'Year', width: '100px' },
        { data: 'Geographic_area', width: '100px' },
        { data: 'Detail_level', width: '100px' },
        { data: 'State', width: '100px' },
        { data: 'Creator', width: '100px' },
        { data: 'dat_grov', width: '100px' },
        { data: 'Usefull_info', width: '100px' },
        { data: 'Reference', width: '100px' },
        { data: 'Pagenumber', width: '100px' },
        {
          data: 'Digitized_link', width: '100px',
          render: function(url) {
            if (!url || url.trim().toLowerCase() === 'x') {
              return `<span class="text-danger">
                        <i class="fas fa-frown"></i> No link
                      </span>`;
            }
            return `<a href="${url}" target="_blank" class="btn btn-sm btn-primary">Link</a>`;
          }
        },
        { data: 'Transcribed', width: '100px' },
        { data: 'Tabulated', width: '100px' },
        {
          data: 'Transcription_link', width: '100px',
          render: function(url) {
            if (!url || url.trim().toLowerCase() === 'x') {
              return `<span class="text-danger">
                        <i class="fas fa-frown"></i> No link
                      </span>`;
            }
            return `<a href="${url}" target="_blank" class="btn btn-sm btn-success">Transcription</a>`;
          }
        },
        {
          data: 'Table_link', width: '100px',
          render: function(url) {
            if (!url || url.trim().toLowerCase() === 'x') {
              return `<span class="text-danger">
                        <i class="fas fa-frown"></i> No link
                      </span>`;
            }
            return `<a href="${url}" target="_blank" class="btn btn-sm btn-info">Table</a>`;
          }
        },
        {
          data: 'Archival_portal_link', width: '100px',
          render: function(url) {
            if (!url || url.trim().toLowerCase() === 'x') {
              return `<span class="text-danger">
                        <i class="fas fa-frown"></i> No link
                      </span>`;
            }
            return `<a href="${url}" target="_blank" class="btn btn-sm btn-warning">Archive</a>`;
          }
        }
      ];

      Papa.parse(csvFilePath, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;

          // Fix #2: Use "scrollX" not "scrollx"
          // Fix #3: Use "autoWidth" not "autoWith"
          const table = $('#manntall-table').DataTable({
            data: data,
            columns: columns,
            dom: 'Bfrtip',
            scrollX: true,       // Ensures horizontal scrolling
            autoWidth: false,    // DataTables won't override your widths
            buttons: [
              {
                extend: 'csvHtml5',
                text: 'Download CSV',
                className: 'btn btn-primary'
              }
            ],
            paging: false,
            ordering: true,
            searching: true,
            info: false,
            lengthChange: false,

            initComplete: function() {
              const api = this.api();
              // Per-column search in the second row
              $('#manntall-table thead tr:eq(1) th').each(function(index) {
                $('input', this).on('keyup change', function() {
                  if (api.column(index).search() !== this.value) {
                    api.column(index).search(this.value).draw();
                  }
                });
              });
            }
          });
        }
      });
    });
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const topScroll = document.getElementById('top-scrollbar');
      const topScrollContent = document.getElementById('top-scroll-content');
      const tableContainer = document.getElementById('table-container');
      const manntallTable = document.getElementById('manntall-table');
    
      function updateScrollWidths() {
        const tableWidth = manntallTable.scrollWidth;
        topScrollContent.style.width = tableWidth + 'px';
      }
    
      // Sync horizontal scroll:
      topScroll.addEventListener('scroll', () => {
        tableContainer.scrollLeft = topScroll.scrollLeft;
      });
      tableContainer.addEventListener('scroll', () => {
        topScroll.scrollLeft = tableContainer.scrollLeft;
      });
    
      // When the table is loaded or on window resize, recalc:
      updateScrollWidths();
      window.addEventListener('resize', updateScrollWidths);
    });
  </script>
</body>
</html>
